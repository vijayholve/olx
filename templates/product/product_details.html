{% extends 'base/main.html' %}
{% load custom_filters %}
{% block css_content %}
{% load static %}
<link rel="stylesheet" href="{% static 'product/product_details.css' %}"> 
<link rel="stylesheet" href="{% static 'product/prod_car.css' %}?v={{time}}">
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

{% endblock css_content %}


{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-md-6">
            <div id="imageCarousel" class="carousel slide" data-bs-ride="carousel">
                <div class="carousel-inner">
                    {% for image in product.images.all %}
                        <div class="carousel-item {% if forloop.first %}active{% endif %}">
                            <img id="mainImage" src="{{ image.image.url }}" class="d-block w-100 main-img" alt="{{ product.title }}">
                        </div>
                    {% endfor %}
                </div>
                <button class="carousel-control-prev border-dark" type="button" data-bs-target="#imageCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#imageCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>

            <div class="d-flex flex-wrap mt-3">
                {% for image in product.images.all %}
                    <img src="{{ image.image.url }}" class="img-thumbnail m-1" style="width: 80px; height: auto; cursor: pointer;" onclick="changeImage('{{ image.image.url }}')">
                {% endfor %}
            </div>
        </div>

        <div class="col-md-6">
            <h1>{{ product.title }}</h1>
            <p>{{ product.description }}</p>
            <ul class="list-unstyled">
                <li><strong>Location:</strong> {{ product.location }}</li>
                <li><strong>Condition:</strong> {{ product.condition }}</li>
                <li><strong>State:</strong> {{ product.state }}</li>
                <li><strong>Active:</strong> {{ product.is_active|yesno:"Yes,No" }}</li>
            </ul>
            <h3 class="text-primary">$ {{ product.price }}</h3>
            <button class="btn btn-primary  mt-2" id="payment-process">Payment</button>

            <button class="btn btn-success mt-2">Send Message</button>
        </div>
    </div>
</div>
<script>
    document.querySelector('#payment-process').addEventListener('click', async function() {
        try {
            const response = await fetch("{% url 'payment-product' product.id %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                credentials: 'same-origin'  // ensure cookies like CSRF work
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error("Server error:", errorText);
                throw new Error("Network response was not ok");
            }
            

            const data = await response.json();

            console.log("Payment data:", data);

            // Razorpay popup here if needed:
            const options = {
                "key": data.razorpay_key_id,
                "amount": data.amount,
                "currency": "INR",
                "name": data.product_name,
                "order_id": data.order_id,
                "callback_url": data.razorpay_callback_url, // optional but recommended
                "handler": function (response) {
                    alert('Payment successful! Payment ID: ' + response.razorpay_payment_id);
                    // Optionally send response.razorpay_payment_id etc. to backend
                },
                "prefill": {
                    "name": "{{ request.user.get_full_name }}",
                    "email": "{{ request.user.email }}",
                },
                "theme": {
                    "color": "#3399cc"
                },
                "modal": {
                    "ondismiss": function () {
                        alert("Payment popup closed.");
                    }
                }
            };
            const rzp = new Razorpay(options);
            rzp.open();
            

        } catch (error) {
            console.error("Fetch error:", error);
        }
    });
</script>

<div class="container py-5">
    <h2 class="mb-4">Suggested <strong>Products</strong></h2>
    <div id="suggestedProductsCarousel" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-indicators">
            {% for group in grouped_suggested_products %}
                <button type="button" data-bs-target="#suggestedProductsCarousel" data-bs-slide-to="{{ forloop.counter0 }}"
                        class="{% if forloop.first %}active{% endif %}" {% if forloop.first %}aria-current="true"{% endif %}
                        aria-label="Slide {{ forloop.counter }}"></button>
            {% endfor %}
        </div>

        <div class="carousel-inner">
            {% for group in grouped_suggested_products %}
                <div class="carousel-item {% if forloop.first %}active{% endif %}">
                    <div class="row">
                        {% for sugg_product in group %}
                            <div class="col-sm-6 col-md-3 mb-3">
                                <div class="card h-100 shadow-sm">
                                    {% if suggest_product_images|get_item:sugg_product.id %}
                                        <img src="{{ suggest_product_images|get_item:sugg_product.id }}" class="card-img-top" alt="{{ sugg_product.name }}">
                                    {% else %}
                                        <img src="/path/to/placeholder-image.jpg" class="card-img-top" alt="No image available">
                                    {% endif %}
                                    <div class="card-body">
                                        <h5 class="card-title">{{ sugg_product.name }}</h5>
                                        <p class="card-text text-primary">$ {{ sugg_product.price }}</p>
                                        <a href="{% url 'product_details' sugg_product.id %}" class="btn btn-outline-primary btn-sm">View Product</a>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        </div>

        <button class="carousel-control-prev w-10 h-10 bg-danger " type="button" data-bs-target="#suggestedProductsCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next bg-danger  " type="button" data-bs-target="#suggestedProductsCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
        </button>
    </div>
</div>

<script>
    function changeImage(imageSrc) {
        document.getElementById('mainImage').src = imageSrc;
    }
</script>
{% endblock content %}
